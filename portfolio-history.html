<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio History ‚Äì Profolio</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js with Luxon date adapter for time scale -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    
    <!-- Theme color -->
    <meta name="theme-color" content="#0a0e17">
    
    <style>
        /* Custom Properties - Dark Mode (Default) */
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-tertiary: #1a2332;
            --bg-elevated: #1f2937;
            
            --glass-bg: rgba(17, 24, 39, 0.7);
            --glass-border: rgba(56, 189, 248, 0.1);
            
            --accent-primary: #38bdf8;
            --accent-secondary: #22d3ee;
            --accent-tertiary: #0ea5e9;
            --accent-glow: rgba(56, 189, 248, 0.4);
            
            --positive: #10b981;
            --positive-bg: rgba(16, 185, 129, 0.15);
            --negative: #f43f5e;
            --negative-bg: rgba(244, 63, 94, 0.15);
            --warning: #fbbf24;
            
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-tertiary: #64748b;
            --text-muted: #475569;
            
            --border-subtle: rgba(148, 163, 184, 0.1);
            --border-default: rgba(148, 163, 184, 0.2);
            
            --font-display: 'Space Mono', 'JetBrains Mono', monospace;
            --font-body: 'DM Sans', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Light Mode Theme */
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-elevated: #e2e8f0;
            
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(14, 165, 233, 0.15);
            
            --accent-primary: #0ea5e9;
            --accent-secondary: #06b6d4;
            --accent-tertiary: #0284c7;
            --accent-glow: rgba(14, 165, 233, 0.25);
            
            --positive: #059669;
            --positive-bg: rgba(5, 150, 105, 0.12);
            --negative: #dc2626;
            --negative-bg: rgba(220, 38, 38, 0.1);
            --warning: #d97706;
            
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --text-muted: #94a3b8;
            
            --border-subtle: rgba(148, 163, 184, 0.2);
            --border-default: rgba(148, 163, 184, 0.4);
            
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(56, 189, 248, 0.12), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(16, 185, 129, 0.08), transparent);
            pointer-events: none;
            z-index: -1;
        }
        
        /* Grid pattern */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: -1;
        }
        
        /* Top Navigation Bar */
        .top-nav {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 0 24px;
            transition: background var(--transition-base), border-color var(--transition-base);
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
        }
        
        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .nav-brand i {
            color: var(--accent-primary);
            font-size: 1.1rem;
        }
        
        .nav-links {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .nav-link i {
            font-size: 0.9rem;
        }
        
        .nav-link:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
            border-color: var(--border-default);
        }
        
        .nav-link.active {
            color: var(--accent-primary);
            background: rgba(56, 189, 248, 0.1);
            border-color: rgba(56, 189, 248, 0.2);
            z-index: -1;
            mask-image: radial-gradient(ellipse 100% 100% at 50% 0%, black, transparent 70%);
        }
        
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
            padding-left: 16px;
            border-left: 1px solid var(--border-subtle);
        }
        
        .theme-toggle-btn {
            position: relative;
            width: 52px;
            height: 28px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            cursor: pointer;
            transition: all var(--transition-base);
            padding: 0;
        }
        
        .theme-toggle-btn:hover {
            border-color: var(--accent-primary);
        }
        
        .theme-toggle-btn::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 50%;
            transition: transform var(--transition-base);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        [data-theme="light"] .theme-toggle-btn::before {
            transform: translateX(24px);
        }
        
        .theme-toggle-icon {
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: color var(--transition-base);
        }
        
        .theme-toggle-icon.moon { display: block; }
        .theme-toggle-icon.sun { display: none; }
        
        [data-theme="light"] .theme-toggle-icon.moon { display: none; }
        [data-theme="light"] .theme-toggle-icon.sun { display: block; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Header */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--accent-primary), var(--accent-secondary), var(--accent-primary), transparent);
            opacity: 0.6;
        }
        
        .header h1 {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .header h1 i {
            color: var(--accent-primary);
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }
        
        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        .back-link {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
            font-size: 0.875rem;
            transition: all 0.25s ease;
        }
        
        .back-link:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            background: rgba(56, 189, 248, 0.1);
        }
        
        /* Chart Container */
        .chart-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 24px;
            position: relative;
            height: 500px;
        }
        
        /* Stats Grid */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            transition: all 0.25s ease;
        }
        
        .stat-card:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--accent-glow);
            transform: translateY(-2px);
        }
        
        .stat-value {
            font-family: var(--font-mono);
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .stat-label {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 600;
        }
        
        .positive { color: var(--positive) !important; }
        .negative { color: var(--negative) !important; }
        
        /* Export Controls */
        .export-controls {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }
        
        .export-controls-title {
            font-family: var(--font-display);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-controls-title i {
            color: var(--accent-primary);
        }
        
        .date-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .date-group label {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }
        
        .date-input {
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.875rem;
            outline: none;
            transition: all 0.25s ease;
        }
        
        .date-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(0.7);
            cursor: pointer;
        }
        
        .export-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-tertiary));
            border: none;
            border-radius: var(--radius-md);
            color: var(--bg-primary);
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.25s ease;
            margin-left: auto;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--accent-glow);
        }
        
        .export-btn:active {
            transform: translateY(0);
        }
        
        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .date-separator {
            color: var(--text-tertiary);
            font-size: 0.875rem;
        }
        
        /* Loading & Error States */
        .loading, .error {
            text-align: center;
            padding: 80px 20px;
            font-size: 1.1rem;
        }
        
        .loading {
            color: var(--text-secondary);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 16px;
            display: block;
            color: var(--accent-primary);
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .error {
            color: var(--negative);
        }
        
        .error i {
            font-size: 2rem;
            margin-bottom: 16px;
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 24px 16px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .back-link {
                position: static;
                transform: none;
                margin-bottom: 16px;
                display: inline-flex;
            }
            
            .chart-container {
                height: 350px;
                padding: 16px;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stat-value {
                font-size: 1.25rem;
            }
            
            .export-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-controls-title {
                margin-bottom: 8px;
            }
            
            .date-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .export-btn {
                margin-left: 0;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-chart-pie"></i>
                <span>Profolio</span>
            </div>
            <ul class="nav-links">
                <li><a href="/" class="nav-link"><i class="fas fa-wallet"></i> Portfolio</a></li>
                <li><a href="/portfolio-history.html" class="nav-link active"><i class="fas fa-chart-line"></i> History</a></li>
                <li><a href="/projects.html" class="nav-link"><i class="fas fa-rocket"></i> Projects</a></li>
            </ul>
            <div class="theme-toggle">
                <i class="fas fa-moon theme-toggle-icon moon"></i>
                <i class="fas fa-sun theme-toggle-icon sun"></i>
                <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle dark/light mode"></button>
            </div>
        </div>
    </nav>

    <div class="container">
        <header class="header">
            <h1>
                <i class="fas fa-chart-area"></i>
                Portfolio History
            </h1>
            <p>Track your portfolio performance over time</p>
        </header>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            Loading portfolio data...
        </div>
        
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            Error loading portfolio data. Please check the console for details.
        </div>
        
        <div id="content" style="display: none;">
            <!-- Export Controls -->
            <div class="export-controls">
                <div class="export-controls-title">
                    <i class="fas fa-download"></i>
                    ÂØºÂá∫ÂéÜÂè≤Êï∞ÊçÆ
                </div>
                <div class="date-group">
                    <label for="startDate">ÂºÄÂßãÊó•Êúü</label>
                    <input type="date" id="startDate" class="date-input">
                </div>
                <span class="date-separator">Ëá≥</span>
                <div class="date-group">
                    <label for="endDate">Êà™Ê≠¢Êó•Êúü</label>
                    <input type="date" id="endDate" class="date-input">
                </div>
                <button class="export-btn" onclick="exportHistory()">
                    <i class="fas fa-file-export"></i>
                    ‰∏ÄÈîÆÂØºÂá∫
                </button>
            </div>
            
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="currentValue">$0</div>
                    <div class="stat-label">Current Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalGain">$0</div>
                    <div class="stat-label">Total Gain/Loss</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalGainPercent">0%</div>
                    <div class="stat-label">Total Return</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="dataPoints">0</div>
                    <div class="stat-label">Data Points</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auth handling
        (function initAuth() {
            const urlParams = new URLSearchParams(window.location.search);
            const authToken = urlParams.get('auth');
            if (authToken) {
                localStorage.setItem('profolio_auth', authToken);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                const token = localStorage.getItem('profolio_auth');
                if (token) {
                    options.headers = options.headers || {};
                    options.headers['X-Auth-Token'] = token;
                }
                return originalFetch(url, options);
            };
            
            // Update all navigation links to include auth token
            const token = localStorage.getItem('profolio_auth');
            if (token) {
                document.addEventListener('DOMContentLoaded', function() {
                    document.querySelectorAll('a.nav-link, .nav-links a').forEach(link => {
                        const href = link.getAttribute('href');
                        if (href && !href.startsWith('http') && !href.includes('auth=')) {
                            const separator = href.includes('?') ? '&' : '?';
                            link.setAttribute('href', href + separator + 'auth=' + token);
                        }
                    });
                });
            }
        })();

        // Theme Toggle
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            document.addEventListener('DOMContentLoaded', function() {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', function() {
                        const currentTheme = document.documentElement.getAttribute('data-theme');
                        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                        document.documentElement.setAttribute('data-theme', newTheme);
                        localStorage.setItem('theme', newTheme);
                    });
                }
            });
        })();

        let portfolioData = [];
        let chart = null;

        async function loadPortfolioData() {
            try {
                const response = await fetch('/api/snapshots');
                const snapshots = await response.json();
                
                console.log(`Found ${snapshots.length} snapshot files`);
                
                portfolioData = snapshots.map(snapshot => ({
                    timestamp: new Date(snapshot.timestamp),
                    totalValue: snapshot.totalValue,
                    totalCost: snapshot.totalCost,
                    totalPnl: snapshot.totalPnl,
                    totalPnlPercent: snapshot.totalPnlPercent,
                    description: snapshot.description
                }));
                
                portfolioData.sort((a, b) => a.timestamp - b.timestamp);
                
                console.log(`Successfully loaded ${portfolioData.length} data points`);
                
                if (portfolioData.length === 0) {
                    throw new Error('No valid portfolio data found');
                }
                
                return portfolioData;
                
            } catch (error) {
                console.error('Error loading portfolio data:', error);
                throw error;
            }
        }

        function createChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            // Create data points with {x: timestamp (ms), y: value} format for proper time scaling
            const valueData = portfolioData.map(item => ({
                x: item.timestamp.getTime(),
                y: item.totalValue
            }));
            
            const costData = portfolioData.map(item => ({
                x: item.timestamp.getTime(),
                y: item.totalCost
            }));
            
            const gainData = portfolioData.map(item => ({
                x: item.timestamp.getTime(),
                y: item.totalPnl
            }));
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            data: valueData,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#38bdf8',
                            pointBorderColor: '#0ea5e9',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointHoverBackgroundColor: '#22d3ee'
                        },
                        {
                            label: 'Total Cost',
                            data: costData,
                            borderColor: '#f43f5e',
                            backgroundColor: 'rgba(244, 63, 94, 0.05)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5],
                            pointBackgroundColor: '#f43f5e',
                            pointBorderColor: '#e11d48',
                            pointBorderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Gain/Loss',
                            data: gainData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#059669',
                            pointBorderWidth: 2,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    parsing: {
                        xAxisKey: 'x',
                        yAxisKey: 'y'
                    },
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: {
                                    family: "'JetBrains Mono', monospace",
                                    size: 11,
                                    weight: 500
                                },
                                color: '#94a3b8'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(17, 24, 39, 0.95)',
                            titleColor: '#f1f5f9',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(56, 189, 248, 0.3)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            titleFont: {
                                family: "'JetBrains Mono', monospace",
                                size: 12,
                                weight: 600
                            },
                            bodyFont: {
                                family: "'JetBrains Mono', monospace",
                                size: 11
                            },
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const label = context.dataset.label;
                                    const prefix = value >= 0 ? '' : '';
                                    return ` ${label}: $${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'timeseries',
                            display: true,
                            time: {
                                tooltipFormat: 'MMM d, yyyy HH:mm'
                            },
                            title: {
                                display: true,
                                text: 'Date',
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 12,
                                    weight: 600
                                },
                                color: '#64748b'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                color: '#64748b',
                                font: {
                                    family: "'JetBrains Mono', monospace",
                                    size: 10
                                },
                                maxTicksLimit: 10,
                                source: 'auto'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Value ($)',
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 12,
                                    weight: 600
                                },
                                color: '#64748b'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                color: '#64748b',
                                font: {
                                    family: "'JetBrains Mono', monospace",
                                    size: 10
                                }
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)',
                                drawBorder: false
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Gain/Loss ($)',
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 12,
                                    weight: 600
                                },
                                color: '#10b981'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                },
                                color: '#10b981',
                                font: {
                                    family: "'JetBrains Mono', monospace",
                                    size: 10
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                                drawBorder: false
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function updateStats() {
            if (portfolioData.length === 0) return;
            
            const latest = portfolioData[portfolioData.length - 1];
            const first = portfolioData[0];
            
            const currentValue = latest.totalValue;
            const totalGain = latest.totalPnl;
            const totalGainPercent = latest.totalPnlPercent;
            const dataPoints = portfolioData.length;
            
            document.getElementById('currentValue').textContent = `$${currentValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const gainElement = document.getElementById('totalGain');
            const gainPrefix = totalGain >= 0 ? '+' : '-';
            gainElement.textContent = `${gainPrefix}$${Math.abs(totalGain).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            gainElement.className = `stat-value ${totalGain >= 0 ? 'positive' : 'negative'}`;
            
            const percentElement = document.getElementById('totalGainPercent');
            const percentPrefix = totalGainPercent >= 0 ? '+' : '';
            percentElement.textContent = `${percentPrefix}${totalGainPercent.toFixed(2)}%`;
            percentElement.className = `stat-value ${totalGainPercent >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('dataPoints').textContent = dataPoints;
        }

        async function init() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('content').style.display = 'none';
                
                await loadPortfolioData();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                createChart();
                updateStats();
                initDatePickers();
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function initDatePickers() {
            if (portfolioData.length === 0) return;
            
            // Set date range based on available data
            const firstDate = portfolioData[0].timestamp;
            const lastDate = portfolioData[portfolioData.length - 1].timestamp;
            
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            
            // Format dates as YYYY-MM-DD for input elements
            startInput.value = firstDate.toISOString().split('T')[0];
            endInput.value = lastDate.toISOString().split('T')[0];
            
            // Set min/max attributes
            startInput.min = firstDate.toISOString().split('T')[0];
            startInput.max = lastDate.toISOString().split('T')[0];
            endInput.min = firstDate.toISOString().split('T')[0];
            endInput.max = lastDate.toISOString().split('T')[0];
        }

        async function exportHistory() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Build query string
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);
            
            const url = `/api/export-history${params.toString() ? '?' + params.toString() : ''}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const filename = response.headers.get('Content-Disposition')?.match(/filename="(.+)"/)?.[1] 
                    || `portfolio-history-${startDate || 'all'}-to-${endDate || 'all'}.csv`;
                
                // Trigger download
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                console.log('Export completed successfully');
            } catch (error) {
                console.error('Export error:', error);
                alert('ÂØºÂá∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        init();
    </script>
</body>
</html>
